'use strict';

const Promise = require('bluebird');
const mongoose = require('mongoose');
const requestId = require('../supports/requestId');
const loggingFactory = require('winrow-logger');

function DisconnectMongoose(params = {}) {
  const { host_mongoose, port_mongoose, name_mongoose } = params;
  const db_url = `mongodb://${host_mongoose}:${port_mongoose}/${name_mongoose}`;
  return new Promise(function (resolve, reject) {
    const disconnect = mongoose.connection.close((err) => {
      if (err) {
        loggingFactory.error(`Disconnection mongoose has error : ${err}`, {
          requestId: `${requestId}`
        });
        reject(err);
      } else {
        loggingFactory.data(`Mongoose disconnect ${db_url}`, {
          requestId: `${requestId}`
        });
      }
    })
    resolve(disconnect)
  })
    .then(() => {
      loggingFactory.debug(`Disconnect ${db_url} complete`, {
        requestId: `${requestId}`
      });
      process.exit(0);
    })
    .catch(err => {
      loggingFactory.error(`Disconnection mongoose has error : ${err}`, {
        requestId: `${requestId}`
      })
      return Promise.reject(err);
    });
};

module.exports = DisconnectMongoose;